---
title: "recommenderlab"
author: "Alexander Kleine"
date: "6/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(recommenderlab)
library(readr)
library(tidyverse)
```


```{r}
final_df <- read_csv("final_df.csv")
final_df[-1] <- na_if(final_df[-1], 1)
apply(final_df[-1], 2, function(x) sum(is.na(x)))

final_df <- as.matrix(final_df[,-1])
rownames(final_df) <- paste0("u", 1:120)
colnames(final_df) <- paste0("i", 1:50)
colnames(final_df)
rownames(final_df)
r <- as(final_df, "realRatingMatrix")
r
```

```{r}
getRatingMatrix(r)
identical(as(r, "matrix"),final_df)
```
write_csv(head(as(r, "data.frame")), path = "df_object_realRatingMatrix.csv")


#Normalization:
normalize {recommenderlab}
Provides the generic for normalize/denormalize and a method to normalize/denormalize the ratings in a realRatingMatrix.

Normalization tries to reduce the individual rating bias by row centering the data, i.e., by subtracting from each available rating the mean of the ratings of that user (row). Z-score in addition divides by the standard deviation of the row/column. Normalization can also be done on columns.

Denormalization reverses normalization. It uses the normalization information stored in x unless the user specifies method, row and factors.
```{r}
r_normalized <- normalize(r)
r_normalized
r_normalized_zscore <- normalize(r, method="Z-score")
image(r_normalized, main = "Normalized Ratings")
image(r_normalized_zscore, main = "Normalized Ratings with z-score")
image(r, main = "Raw Ratings")
```

#Inspection of data set properties
General understanding of the opbject:
```{r}
str(r)

r_sample <- as(sample(r, 5), "list")
r_sample

rowMeans(sample(r, 5))
```

Histgramme:
```{r}
hist(getRatings(r), breaks=5)
hist(getRatings(r_normalized), breaks=5)
hist(getRatings(r_normalized_zscore), breaks=5)

hist(rowCounts(r), breaks=15)
hist(colMeans(r), breaks=15)
```

#Creating a recommender
By using the function Recommender() we creat the object recommenderRegistry which can be used for dirfferent kind of recommender systems. Depending on the characteristics of you dataframe your have to check which options you would like to use.  
```{r}
recommenderRegistry$get_entries(dataType = "realRatingMatrix")
```

Our first try will be recommender system which generates recommendations based on the popularity of a items (song with highest number of users which have the song in their profile). We create a recommender from the first 50 users in the dataset.

```{r}
r_model <- Recommender(r[1:120], method = "POPULAR")
r_model
names(getModel(r_model))
getModel(r_model)$topN
```

#Recommendations
Recommendations are generated by predict(). The result are recommendations in the form of an object of class TopNList. Here we create top-5 recommendation lists for two users who were not used to learn the model.
The recomendations will be made upto 5 Songs. In case the user only unfamiliar with less then 5 Song, the prediction only covers the remaining ones. 

```{r}
recom <- predict(r_model, r[c(39,100,101,5)], n=15)
recom
as(recom, "list")
```

#Secound Model
This time we use the recommender method "UBCF" out of realRatingMatrix.
Therefore we genrate a recommender based on user-based collaborative filtering:
```{r}
r_model_2 <- Recommender(r[1:120], method = "UBCF")
r_model_2
names(getModel(r_model_2))
getModel(r_model_2)$min_matching_items
```

```{r}
recom2 <- predict(r_model_2, r[c(39,100,101,5)], n=15)
recom2
as(recom2, "list")
```


